{% extends "layout.html" %}
{% block content %}
<div class="container mx-auto mt-10">
    <h1 class="text-3xl font-bold mb-6 text-center text-purple-700 dark:text-purple-300">BRD to App AI Platform</h1>

    {% if error_message %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline">{{ error_message }}</span>
            {% if ai_analysis_data and ai_analysis_data.raw_ai_response %}
                <p class="mt-2"><strong>Raw AI Response (for debugging JSON parsing):</strong></p>
                <pre class="code-block">{{ ai_analysis_data.raw_ai_response }}</pre>
            {% endif %}
        </div>
    {% elif ai_analysis_data and not ai_analysis_data.parse_error %} {# Only show success if no parsing error #}
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Success!</strong> BRD analysis completed for "{{ filename }}".
        </div>
    {% endif %}

    <div class="lg:col-span-2" id="uploadSection">
        <div id="dropZone" class="neo-card rounded-2xl p-8 border-2 border-dashed border-gray-300 dark:border-gray-600 text-center hover:border-purple-400 dark:hover:border-purple-500 transition-all duration-300 cursor-pointer file-upload-hover">
            
            <form method="post" enctype="multipart/form-data" id="brdUploadForm">
                {% csrf_token %}
                
                <div id="uploadContent">
                    <svg class="mx-auto h-16 w-16 text-gray-400 dark:text-gray-500 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Drop your BRD here</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">or click to browse files</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">Supports PDF, DOC, DOCX, TXT (Max 10MB)</p>
                    <input type="file" id="fileInput" name="brd_file" class="hidden" accept=".pdf,.doc,.docx,.txt" multiple>
                    
                    <div id="selectedFileName" class="text-gray-700 dark:text-gray-300 mt-2"></div>

                    <button 
                        type="button" 
                        onclick="document.getElementById('fileInput').click()" 
                        class="mt-4 px-6 py-3 gradient-bg text-white rounded-xl font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-300">
                        Choose File
                    </button>
            
                    <button 
                        type="submit" 
                        id="submitButton"
                        class="mt-4 ml-4 px-6 py-3 gradient-bg text-white rounded-xl font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-300 hidden">
                        Upload and Analyze
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="loadingSpinner" class="hidden text-center mt-8">
        <svg class="animate-spin h-10 w-10 text-purple-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">Analyzing your BRD... This might take a moment.</p>
    </div>

    <div id="analysisResultSection" class="mt-10 {% if not ai_analysis_data and not error_message %}hidden{% endif %}">
        {% if ai_analysis_data and not ai_analysis_data.parse_error %}
            <h2 class="text-2xl font-bold mb-4 text-purple-700 dark:text-purple-300">Analysis Result</h2>
            <hr class="mb-6 border-purple-200">

            {% if ai_analysis_data.project_summary %}
                <div class="neo-card p-6 rounded-xl mb-6">
                    <h3 class="text-xl font-semibold mb-3">Project Summary:</h3>
                    <p class="text-gray-700 dark:text-gray-300">{{ ai_analysis_data.project_summary }}</p>
                </div>
            {% else %}
                <p class="text-gray-500 mb-6">No project summary identified by the AI.</p>
            {% endif %}

            {% if ai_analysis_data.themes %}
                <div class="neo-card p-6 rounded-xl mb-6">
                    <h2 class="text-xl font-semibold mb-3">Themes:</h2>
                    {% for theme in ai_analysis_data.themes %}
                        <h3 class="text-lg font-bold text-purple-600 dark:text-purple-400 mt-4">{{ theme.theme_name|default:"Unnamed Theme" }}</h3>
                        <p class="text-gray-700 dark:text-gray-300">{{ theme.description|default:"No description." }}</p>
                        {% if theme.epics %}
                            <h4 class="text-md font-semibold mt-3 mb-2">Epics:</h4>
                            <ul class="list-disc pl-5 text-gray-700 dark:text-gray-300">
                                {% for epic in theme.epics %}
                                    <li class="mb-2">
                                        <strong>{{ epic.epic_name|default:"Unnamed Epic" }}:</strong> {{ epic.description|default:"No description." }}
                                        {% if epic.user_stories %}
                                            <h5 class="text-sm font-semibold mt-2 mb-1">User Stories:</h5>
                                            <ul class="list-circle pl-6 text-gray-600 dark:text-gray-400">
                                                {% for story in epic.user_stories %}
                                                    <li class="mb-1">
                                                        <strong>{{ story.story_id|default:"N/A" }}:</strong> {{ story.title|default:"Untitled Story" }}
                                                        {% if story.acceptance_criteria %}
                                                            <h6 class="text-xs font-semibold mt-1 mb-0">Acceptance Criteria:</h6>
                                                            <ul class="list-square pl-8 text-gray-500 dark:text-gray-500">
                                                                {% for criterion in story.acceptance_criteria %}
                                                                    <li>{{ criterion }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        {% endif %}
                                                        {% if story.tasks %}
                                                            <h6 class="text-xs font-semibold mt-1 mb-0">Tasks:</h6>
                                                            <ul class="list-square pl-8 text-gray-500 dark:text-gray-500">
                                                                {% for task in story.tasks %}
                                                                    <li>{{ task }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500 mb-6">No themes were identified by the AI.</p>
            {% endif %}

            <div class="neo-card p-6 rounded-xl mt-8">
                <h3 class="text-xl font-semibold mb-3">Raw Extracted Text (for reference):</h3>
                <pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded overflow-x-auto text-sm whitespace-pre-wrap text-gray-800 dark:text-gray-200">{{ extracted_text }}</pre>
            </div>
        {% elif ai_analysis_data and ai_analysis_data.parse_error %}
            {# Error details displayed at the top #}
        {% else %}
            {# If no data and no error (initial load), this section is hidden by default #}
        {% endif %}
    </div>

</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const brdUploadForm = document.getElementById('brdUploadForm');
    const submitButton = document.getElementById('submitButton');
    const selectedFileNameDisplay = document.getElementById('selectedFileName');
    const uploadSection = document.getElementById('uploadSection');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const analysisResultSection = document.getElementById('analysisResultSection');

    // Show/hide submit button based on file selection
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            submitButton.classList.remove('hidden');
            selectedFileNameDisplay.textContent = `Selected: ${fileInput.files[0].name}`;
        } else {
            submitButton.classList.add('hidden');
            selectedFileNameDisplay.textContent = '';
        }
    });

    // Handle drag & drop
    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-purple-500', 'bg-purple-50', 'dark:bg-purple-900'); // Add hover effect
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-purple-500', 'bg-purple-50', 'dark:bg-purple-900'); // Remove hover effect
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-purple-500', 'bg-purple-50', 'dark:bg-purple-900'); // Remove hover effect
            fileInput.files = e.dataTransfer.files; // Assign dropped files to input
            
            // Automatically submit the form after dropping files
            if (fileInput.files.length > 0) {
                brdUploadForm.submit(); 
                showLoadingState(); // Show loading spinner immediately
            }
        });

        // Prevent default drag behaviors for the entire document to avoid issues
        document.addEventListener('dragover', (e) => e.preventDefault());
        document.addEventListener('drop', (e) => e.preventDefault());
    }

    // Handle form submission to show loading spinner
    brdUploadForm.addEventListener('submit', () => {
        showLoadingState();
    });

    function showLoadingState() {
        uploadSection.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');
        analysisResultSection.classList.add('hidden'); // Hide previous results
    }

    // Revert to initial state if page reloads without results (e.g., direct navigation)
    // This assumes results are only available after a POST.
    // If you want to persist results, you'd need local storage or session data.
    if (!analysisResultSection.querySelector('.success-message') && !analysisResultSection.querySelector('.error-message')) {
        analysisResultSection.classList.add('hidden');
    }

</script>
{% endblock %}